name: $(date:yyyyMMdd)$(rev:.r)

trigger: 
- master

pool:
  vmImage: ubuntu-18.04
  workspace:
    clean: all

jobs:
- job: Job_0
  displayName: 'Build and Test'
  steps:
  - task: CopyFiles@2
    displayName: Copy Files for Artifact
    inputs: 
      SourceFolder: '$(Build.SourcesDirectory)'
      Contents: |
        **/*
        !.git/**/*
        !.vscode/**/*
      TargetFolder: '$(Build.ArtifactStagingDirectory)'

  - task: DotNetCoreCLI@2
    displayName: Nuget Restore
    inputs:
      command: restore
      projects: '**/*.csproj'
      
  - task: DotNetCoreCLI@2
    displayName: 'Build'
    inputs:
      projects: '**/*.csproj'
      arguments: '--configuration $(BuildConfiguration)'
  
  - task: DotNetCoreCLI@2
    displayName: Test
    inputs:
      command: test
      projects: '**/Processor.sln'
      arguments: '-c $(BuildConfiguration) --no-build --logger trx --collect "XPlat Code Coverage" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura,opencover'
  
  - task: PublishCodeCoverageResults@1
    displayName: 'Publish code coverage results'
    inputs:
      codeCoverageTool: cobertura
      summaryFileLocation: '$(Agent.TempDirectory)/**/coverage.cobertura.xml'
  
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    condition: succeeded()